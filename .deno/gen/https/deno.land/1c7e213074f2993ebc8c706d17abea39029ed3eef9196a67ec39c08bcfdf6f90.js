import { AuthorizationResponseError, OAuth2ResponseError } from "./errors.ts";
import { OAuth2GrantBase } from "./grant_base.ts";
/**
 * Implements the OAuth 2.0 authorization code grant.
 *
 * See https://tools.ietf.org/html/rfc6749#section-4.1
 */ export class AuthorizationCodeGrant extends OAuth2GrantBase {
    constructor(client){
        super(client);
    }
    /** Builds a URI you can redirect a user to to make the authorization request. */ getAuthorizationUri(options = {}) {
        const params = new URLSearchParams();
        params.set("client_id", this.client.config.clientId);
        if (typeof this.client.config.responseType === "string") {
            params.set("response_type", this.client.config.responseType);
        } else {
            params.set("response_type", "code");
        }
        if (typeof this.client.config.redirectUri === "string") {
            params.set("redirect_uri", this.client.config.redirectUri);
        }
        if (typeof this.client.config.includeGrantedScopes === "string") {
            params.set("include_granted_scopes", this.client.config.includeGrantedScopes);
        }
        if (typeof this.client.config.tenant === "string") {
            params.set("tenant", this.client.config.tenant);
        }
        if (typeof this.client.config.codeChallenge === "string") {
            params.set("code_challenge", this.client.config.codeChallenge);
        }
        if (typeof this.client.config.codeChallengeMethod === "string") {
            params.set("code_challenge_method", this.client.config.codeChallengeMethod);
        }
        if (typeof this.client.config.responseMode === "string") {
            params.set("response_mode", this.client.config.responseMode);
        }
        if (options.state) {
            params.set("state", options.state);
        }
        const scope = options.scope ?? this.client.config.defaults?.scope;
        if (scope) {
            params.set("scope", Array.isArray(scope) ? scope.join(" ") : scope);
        }
        return new URL(`?${params}`, this.client.config.authorizationEndpointUri);
    }
    /**
   * Parses the authorization response request tokens from the authorization server.
   *
   * Usually you'd want to call this method in the function that handles the user's request to your configured redirectUri.
   * @param authResponseUri The complete URI the user got redirected to by the authorization server after making the authorization request.
   *     Must include all received URL parameters.
   */ async getToken(authResponseUri, options = {}) {
        const validated = this.validateAuthorizationResponse(this.toUrl(authResponseUri), options);
        const request = this.buildAccessTokenRequest(validated.code, options.requestOptions);
        const accessTokenResponse = await fetch(request);
        return this.parseTokenResponse(accessTokenResponse);
    }
    validateAuthorizationResponse(url, options) {
        if (typeof this.client.config.redirectUri === "string") {
            const expectedUrl = new URL(this.client.config.redirectUri);
            if (typeof url.pathname === "string" && url.pathname !== expectedUrl.pathname) {
                throw new AuthorizationResponseError(`Redirect path should match configured path, but got: ${url.pathname}`);
            }
        }
        if (!url.search || !url.search.substr(1)) {
            throw new AuthorizationResponseError(`URI does not contain callback parameters: ${url}`);
        }
        const params = new URLSearchParams(url.search || "");
        if (params.get("error") !== null) {
            throw OAuth2ResponseError.fromURLSearchParams(params);
        }
        const code = params.get("code") || "";
        if (!code) {
            throw new AuthorizationResponseError("Missing code, unable to request token");
        }
        const state = params.get("state");
        const stateValidator = options.stateValidator || options.state && ((s)=>s === options.state) || this.client.config.defaults?.stateValidator;
        if (stateValidator && !stateValidator(state)) {
            if (state === null) {
                throw new AuthorizationResponseError("Missing state");
            } else {
                throw new AuthorizationResponseError(`Invalid state: ${params.get("state")}`);
            }
        }
        if (state) {
            return {
                code,
                state
            };
        }
        return {
            code
        };
    }
    buildAccessTokenRequest(code, requestOptions = {}) {
        const body = {
            "grant_type": "authorization_code",
            code
        };
        const headers = {
            "Accept": "application/json",
            "content-type": "application/x-www-form-urlencoded"
        };
        if (typeof this.client.config.redirectUri === "string") {
            body.redirect_uri = this.client.config.redirectUri;
        }
        if (typeof this.client.config.clientSecret === "string") {
            // We have a client secret, authenticate using HTTP Basic Auth as described in RFC6749 Section 2.3.1.
            const { clientId , clientSecret  } = this.client.config;
            headers.Authorization = `Basic ${btoa(`${clientId}:${clientSecret}`)}`;
        } else {
            // This appears to be a public client, include the client ID along in the body
            body.client_id = this.client.config.clientId;
        }
        return this.buildRequest(this.client.config.tokenUri, {
            method: "POST",
            headers,
            body
        }, requestOptions);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImh0dHBzOi8vZGVuby5sYW5kL3gvb2F1dGgyQHYwLjIuNi9zcmMvYXV0aG9yaXphdGlvbl9jb2RlX2dyYW50LnRzIl0sInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB0eXBlIHsgT0F1dGgyQ2xpZW50IH0gZnJvbSBcIi4vb2F1dGgyX2NsaWVudC50c1wiO1xuaW1wb3J0IHsgQXV0aG9yaXphdGlvblJlc3BvbnNlRXJyb3IsIE9BdXRoMlJlc3BvbnNlRXJyb3IgfSBmcm9tIFwiLi9lcnJvcnMudHNcIjtcbmltcG9ydCB7IFJlcXVlc3RPcHRpb25zLCBUb2tlbnMgfSBmcm9tIFwiLi90eXBlcy50c1wiO1xuaW1wb3J0IHsgT0F1dGgyR3JhbnRCYXNlIH0gZnJvbSBcIi4vZ3JhbnRfYmFzZS50c1wiO1xuXG5leHBvcnQgaW50ZXJmYWNlIEdldFVyaU9wdGlvbnMge1xuICAvKipcbiAgICogU3RhdGUgcGFyYW1ldGVyIHRvIHNlbmQgYWxvbmcgd2l0aCB0aGUgYXV0aG9yaXphdGlvbiByZXF1ZXN0LlxuICAgKlxuICAgKiBzZWUgaHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzY3NDkjc2VjdGlvbi00LjEuMVxuICAgKi9cbiAgc3RhdGU/OiBzdHJpbmc7XG4gIC8qKlxuICAgKiBTY29wZXMgdG8gcmVxdWVzdCB3aXRoIHRoZSBhdXRob3JpemF0aW9uIHJlcXVlc3QuXG4gICAqXG4gICAqIElmIGFuIGFycmF5IGlzIHBhc3NlZCwgaXQgaXMgY29uY2F0aW5hdGVkIHVzaW5nIHNwYWNlcyBhcyBwZXJcbiAgICogaHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzY3NDkjc2VjdGlvbi0zLjNcbiAgICovXG4gIHNjb3BlPzogc3RyaW5nIHwgc3RyaW5nW107XG59XG5cbmV4cG9ydCBpbnRlcmZhY2UgR2V0VG9rZW5PcHRpb25zIHtcbiAgLyoqXG4gICAqIFRoZSBzdGF0ZSBwYXJhbWV0ZXIgZXhwZWN0ZWQgdG8gYmUgcmV0dXJuZWQgYnkgdGhlIGF1dGhvcml6YXRpb24gcmVzcG9uc2UuXG4gICAqXG4gICAqIFVzdWFsbHkgeW91J2Qgc3RvcmUgdGhlIHN0YXRlIHlvdSBzZW50IHdpdGggdGhlIGF1dGhvcml6YXRpb24gcmVxdWVzdCBpbiB0aGVcbiAgICogdXNlcidzIHNlc3Npb24gc28geW91IGNhbiBwYXNzIGl0IGhlcmUuXG4gICAqIElmIGl0IGNvdWxkIGJlIG9uZSBvZiBtYW55IHN0YXRlcyBvciB5b3Ugd2FudCB0byBydW4gc29tZSBjdXN0b20gdmVyaWZpY2F0aW9uXG4gICAqIGxvZ2ljLCB1c2UgdGhlIGBzdGF0ZVZhbGlkYXRvcmAgcGFyYW1ldGVyIGluc3RlYWQuXG4gICAqL1xuICBzdGF0ZT86IHN0cmluZztcbiAgLyoqXG4gICAqIFRoZSBzdGF0ZSB2YWxpZGF0b3IgdXNlZCB0byB2ZXJpZnkgdGhhdCB0aGUgcmVjZWl2ZWQgc3RhdGUgaXMgdmFsaWQuXG4gICAqXG4gICAqIFRoZSBvcHRpb24gb2JqZWN0J3Mgc3RhdGUgdmFsdWUgaXMgaWdub3JlZCB3aGVuIGEgc3RhdGVWYWxpZGF0b3IgaXMgcGFzc2VkLlxuICAgKi9cbiAgc3RhdGVWYWxpZGF0b3I/OiAoc3RhdGU6IHN0cmluZyB8IG51bGwpID0+IGJvb2xlYW47XG4gIC8qKiBSZXF1ZXN0IG9wdGlvbnMgdXNlZCB3aGVuIG1ha2luZyB0aGUgYWNjZXNzIHRva2VuIHJlcXVlc3QuICovXG4gIHJlcXVlc3RPcHRpb25zPzogUmVxdWVzdE9wdGlvbnM7XG59XG5cbi8qKlxuICogSW1wbGVtZW50cyB0aGUgT0F1dGggMi4wIGF1dGhvcml6YXRpb24gY29kZSBncmFudC5cbiAqXG4gKiBTZWUgaHR0cHM6Ly90b29scy5pZXRmLm9yZy9odG1sL3JmYzY3NDkjc2VjdGlvbi00LjFcbiAqL1xuZXhwb3J0IGNsYXNzIEF1dGhvcml6YXRpb25Db2RlR3JhbnQgZXh0ZW5kcyBPQXV0aDJHcmFudEJhc2Uge1xuICBjb25zdHJ1Y3RvcihjbGllbnQ6IE9BdXRoMkNsaWVudCkge1xuICAgIHN1cGVyKGNsaWVudCk7XG4gIH1cblxuICAvKiogQnVpbGRzIGEgVVJJIHlvdSBjYW4gcmVkaXJlY3QgYSB1c2VyIHRvIHRvIG1ha2UgdGhlIGF1dGhvcml6YXRpb24gcmVxdWVzdC4gKi9cbiAgcHVibGljIGdldEF1dGhvcml6YXRpb25Vcmkob3B0aW9uczogR2V0VXJpT3B0aW9ucyA9IHt9KTogVVJMIHtcbiAgICBjb25zdCBwYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKCk7XG4gICAgcGFyYW1zLnNldChcImNsaWVudF9pZFwiLCB0aGlzLmNsaWVudC5jb25maWcuY2xpZW50SWQpO1xuICAgIGlmICh0eXBlb2YgdGhpcy5jbGllbnQuY29uZmlnLnJlc3BvbnNlVHlwZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcGFyYW1zLnNldChcInJlc3BvbnNlX3R5cGVcIiwgdGhpcy5jbGllbnQuY29uZmlnLnJlc3BvbnNlVHlwZSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHBhcmFtcy5zZXQoXCJyZXNwb25zZV90eXBlXCIsIFwiY29kZVwiKTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiB0aGlzLmNsaWVudC5jb25maWcucmVkaXJlY3RVcmkgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHBhcmFtcy5zZXQoXCJyZWRpcmVjdF91cmlcIiwgdGhpcy5jbGllbnQuY29uZmlnLnJlZGlyZWN0VXJpKTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiB0aGlzLmNsaWVudC5jb25maWcuaW5jbHVkZUdyYW50ZWRTY29wZXMgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIHBhcmFtcy5zZXQoXCJpbmNsdWRlX2dyYW50ZWRfc2NvcGVzXCIsIHRoaXMuY2xpZW50LmNvbmZpZy5pbmNsdWRlR3JhbnRlZFNjb3Blcyk7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgdGhpcy5jbGllbnQuY29uZmlnLnRlbmFudCA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcGFyYW1zLnNldChcInRlbmFudFwiLCB0aGlzLmNsaWVudC5jb25maWcudGVuYW50KTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiB0aGlzLmNsaWVudC5jb25maWcuY29kZUNoYWxsZW5nZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcGFyYW1zLnNldChcImNvZGVfY2hhbGxlbmdlXCIsIHRoaXMuY2xpZW50LmNvbmZpZy5jb2RlQ2hhbGxlbmdlKTtcbiAgICB9XG4gICAgaWYgKHR5cGVvZiB0aGlzLmNsaWVudC5jb25maWcuY29kZUNoYWxsZW5nZU1ldGhvZCA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcGFyYW1zLnNldChcImNvZGVfY2hhbGxlbmdlX21ldGhvZFwiLCB0aGlzLmNsaWVudC5jb25maWcuY29kZUNoYWxsZW5nZU1ldGhvZCk7XG4gICAgfVxuICAgIGlmICh0eXBlb2YgdGhpcy5jbGllbnQuY29uZmlnLnJlc3BvbnNlTW9kZSA9PT0gXCJzdHJpbmdcIikge1xuICAgICAgcGFyYW1zLnNldChcInJlc3BvbnNlX21vZGVcIiwgdGhpcy5jbGllbnQuY29uZmlnLnJlc3BvbnNlTW9kZSk7XG4gICAgfVxuXG4gICAgaWYgKG9wdGlvbnMuc3RhdGUpIHtcbiAgICAgIHBhcmFtcy5zZXQoXCJzdGF0ZVwiLCBvcHRpb25zLnN0YXRlKTtcbiAgICB9XG4gICAgY29uc3Qgc2NvcGUgPSBvcHRpb25zLnNjb3BlID8/IHRoaXMuY2xpZW50LmNvbmZpZy5kZWZhdWx0cz8uc2NvcGU7XG4gICAgaWYgKHNjb3BlKSB7XG4gICAgICBwYXJhbXMuc2V0KFwic2NvcGVcIiwgQXJyYXkuaXNBcnJheShzY29wZSkgPyBzY29wZS5qb2luKFwiIFwiKSA6IHNjb3BlKTtcbiAgICB9XG4gICAgcmV0dXJuIG5ldyBVUkwoYD8ke3BhcmFtc31gLCB0aGlzLmNsaWVudC5jb25maWcuYXV0aG9yaXphdGlvbkVuZHBvaW50VXJpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQYXJzZXMgdGhlIGF1dGhvcml6YXRpb24gcmVzcG9uc2UgcmVxdWVzdCB0b2tlbnMgZnJvbSB0aGUgYXV0aG9yaXphdGlvbiBzZXJ2ZXIuXG4gICAqXG4gICAqIFVzdWFsbHkgeW91J2Qgd2FudCB0byBjYWxsIHRoaXMgbWV0aG9kIGluIHRoZSBmdW5jdGlvbiB0aGF0IGhhbmRsZXMgdGhlIHVzZXIncyByZXF1ZXN0IHRvIHlvdXIgY29uZmlndXJlZCByZWRpcmVjdFVyaS5cbiAgICogQHBhcmFtIGF1dGhSZXNwb25zZVVyaSBUaGUgY29tcGxldGUgVVJJIHRoZSB1c2VyIGdvdCByZWRpcmVjdGVkIHRvIGJ5IHRoZSBhdXRob3JpemF0aW9uIHNlcnZlciBhZnRlciBtYWtpbmcgdGhlIGF1dGhvcml6YXRpb24gcmVxdWVzdC5cbiAgICogICAgIE11c3QgaW5jbHVkZSBhbGwgcmVjZWl2ZWQgVVJMIHBhcmFtZXRlcnMuXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgZ2V0VG9rZW4oXG4gICAgYXV0aFJlc3BvbnNlVXJpOiBzdHJpbmcgfCBVUkwsXG4gICAgb3B0aW9uczogR2V0VG9rZW5PcHRpb25zID0ge30sXG4gICk6IFByb21pc2U8VG9rZW5zPiB7XG4gICAgY29uc3QgdmFsaWRhdGVkID0gdGhpcy52YWxpZGF0ZUF1dGhvcml6YXRpb25SZXNwb25zZShcbiAgICAgIHRoaXMudG9VcmwoYXV0aFJlc3BvbnNlVXJpKSxcbiAgICAgIG9wdGlvbnMsXG4gICAgKTtcblxuICAgIGNvbnN0IHJlcXVlc3QgPSB0aGlzLmJ1aWxkQWNjZXNzVG9rZW5SZXF1ZXN0KFxuICAgICAgdmFsaWRhdGVkLmNvZGUsXG4gICAgICBvcHRpb25zLnJlcXVlc3RPcHRpb25zLFxuICAgICk7XG5cbiAgICBjb25zdCBhY2Nlc3NUb2tlblJlc3BvbnNlID0gYXdhaXQgZmV0Y2gocmVxdWVzdCk7XG5cbiAgICByZXR1cm4gdGhpcy5wYXJzZVRva2VuUmVzcG9uc2UoYWNjZXNzVG9rZW5SZXNwb25zZSk7XG4gIH1cblxuICBwcml2YXRlIHZhbGlkYXRlQXV0aG9yaXphdGlvblJlc3BvbnNlKFxuICAgIHVybDogVVJMLFxuICAgIG9wdGlvbnM6IEdldFRva2VuT3B0aW9ucyxcbiAgKTogeyBjb2RlOiBzdHJpbmc7IHN0YXRlPzogc3RyaW5nIH0ge1xuICAgIGlmICh0eXBlb2YgdGhpcy5jbGllbnQuY29uZmlnLnJlZGlyZWN0VXJpID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBjb25zdCBleHBlY3RlZFVybCA9IG5ldyBVUkwodGhpcy5jbGllbnQuY29uZmlnLnJlZGlyZWN0VXJpKTtcblxuICAgICAgaWYgKFxuICAgICAgICB0eXBlb2YgdXJsLnBhdGhuYW1lID09PSBcInN0cmluZ1wiICYmXG4gICAgICAgIHVybC5wYXRobmFtZSAhPT0gZXhwZWN0ZWRVcmwucGF0aG5hbWVcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgQXV0aG9yaXphdGlvblJlc3BvbnNlRXJyb3IoXG4gICAgICAgICAgYFJlZGlyZWN0IHBhdGggc2hvdWxkIG1hdGNoIGNvbmZpZ3VyZWQgcGF0aCwgYnV0IGdvdDogJHt1cmwucGF0aG5hbWV9YCxcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIXVybC5zZWFyY2ggfHwgIXVybC5zZWFyY2guc3Vic3RyKDEpKSB7XG4gICAgICB0aHJvdyBuZXcgQXV0aG9yaXphdGlvblJlc3BvbnNlRXJyb3IoXG4gICAgICAgIGBVUkkgZG9lcyBub3QgY29udGFpbiBjYWxsYmFjayBwYXJhbWV0ZXJzOiAke3VybH1gLFxuICAgICAgKTtcbiAgICB9XG5cbiAgICBjb25zdCBwYXJhbXMgPSBuZXcgVVJMU2VhcmNoUGFyYW1zKHVybC5zZWFyY2ggfHwgXCJcIik7XG5cbiAgICBpZiAocGFyYW1zLmdldChcImVycm9yXCIpICE9PSBudWxsKSB7XG4gICAgICB0aHJvdyBPQXV0aDJSZXNwb25zZUVycm9yLmZyb21VUkxTZWFyY2hQYXJhbXMocGFyYW1zKTtcbiAgICB9XG5cbiAgICBjb25zdCBjb2RlID0gcGFyYW1zLmdldChcImNvZGVcIikgfHwgXCJcIjtcbiAgICBpZiAoIWNvZGUpIHtcbiAgICAgIHRocm93IG5ldyBBdXRob3JpemF0aW9uUmVzcG9uc2VFcnJvcihcbiAgICAgICAgXCJNaXNzaW5nIGNvZGUsIHVuYWJsZSB0byByZXF1ZXN0IHRva2VuXCIsXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnN0IHN0YXRlID0gcGFyYW1zLmdldChcInN0YXRlXCIpO1xuICAgIGNvbnN0IHN0YXRlVmFsaWRhdG9yID0gb3B0aW9ucy5zdGF0ZVZhbGlkYXRvciB8fFxuICAgICAgKG9wdGlvbnMuc3RhdGUgJiYgKChzKSA9PiBzID09PSBvcHRpb25zLnN0YXRlKSkgfHxcbiAgICAgIHRoaXMuY2xpZW50LmNvbmZpZy5kZWZhdWx0cz8uc3RhdGVWYWxpZGF0b3I7XG5cbiAgICBpZiAoc3RhdGVWYWxpZGF0b3IgJiYgIXN0YXRlVmFsaWRhdG9yKHN0YXRlKSkge1xuICAgICAgaWYgKHN0YXRlID09PSBudWxsKSB7XG4gICAgICAgIHRocm93IG5ldyBBdXRob3JpemF0aW9uUmVzcG9uc2VFcnJvcihcIk1pc3Npbmcgc3RhdGVcIik7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICB0aHJvdyBuZXcgQXV0aG9yaXphdGlvblJlc3BvbnNlRXJyb3IoXG4gICAgICAgICAgYEludmFsaWQgc3RhdGU6ICR7cGFyYW1zLmdldChcInN0YXRlXCIpfWAsXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHN0YXRlKSB7XG4gICAgICByZXR1cm4geyBjb2RlLCBzdGF0ZSB9O1xuICAgIH1cbiAgICByZXR1cm4geyBjb2RlIH07XG4gIH1cblxuICBwcml2YXRlIGJ1aWxkQWNjZXNzVG9rZW5SZXF1ZXN0KFxuICAgIGNvZGU6IHN0cmluZyxcbiAgICByZXF1ZXN0T3B0aW9uczogUmVxdWVzdE9wdGlvbnMgPSB7fSxcbiAgKTogUmVxdWVzdCB7XG4gICAgY29uc3QgYm9keTogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHtcbiAgICAgIFwiZ3JhbnRfdHlwZVwiOiBcImF1dGhvcml6YXRpb25fY29kZVwiLFxuICAgICAgY29kZSxcbiAgICB9O1xuICAgIGNvbnN0IGhlYWRlcnM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7XG4gICAgICBcIkFjY2VwdFwiOiBcImFwcGxpY2F0aW9uL2pzb25cIixcbiAgICAgIFwiY29udGVudC10eXBlXCI6IFwiYXBwbGljYXRpb24veC13d3ctZm9ybS11cmxlbmNvZGVkXCIsXG4gICAgfTtcblxuICAgIGlmICh0eXBlb2YgdGhpcy5jbGllbnQuY29uZmlnLnJlZGlyZWN0VXJpID09PSBcInN0cmluZ1wiKSB7XG4gICAgICBib2R5LnJlZGlyZWN0X3VyaSA9IHRoaXMuY2xpZW50LmNvbmZpZy5yZWRpcmVjdFVyaTtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIHRoaXMuY2xpZW50LmNvbmZpZy5jbGllbnRTZWNyZXQgPT09IFwic3RyaW5nXCIpIHtcbiAgICAgIC8vIFdlIGhhdmUgYSBjbGllbnQgc2VjcmV0LCBhdXRoZW50aWNhdGUgdXNpbmcgSFRUUCBCYXNpYyBBdXRoIGFzIGRlc2NyaWJlZCBpbiBSRkM2NzQ5IFNlY3Rpb24gMi4zLjEuXG4gICAgICBjb25zdCB7IGNsaWVudElkLCBjbGllbnRTZWNyZXQgfSA9IHRoaXMuY2xpZW50LmNvbmZpZztcbiAgICAgIGhlYWRlcnMuQXV0aG9yaXphdGlvbiA9IGBCYXNpYyAke2J0b2EoYCR7Y2xpZW50SWR9OiR7Y2xpZW50U2VjcmV0fWApfWA7XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIFRoaXMgYXBwZWFycyB0byBiZSBhIHB1YmxpYyBjbGllbnQsIGluY2x1ZGUgdGhlIGNsaWVudCBJRCBhbG9uZyBpbiB0aGUgYm9keVxuICAgICAgYm9keS5jbGllbnRfaWQgPSB0aGlzLmNsaWVudC5jb25maWcuY2xpZW50SWQ7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuYnVpbGRSZXF1ZXN0KHRoaXMuY2xpZW50LmNvbmZpZy50b2tlblVyaSwge1xuICAgICAgbWV0aG9kOiBcIlBPU1RcIixcbiAgICAgIGhlYWRlcnMsXG4gICAgICBib2R5LFxuICAg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